pipeline {
    agent any

    environment {
        REPO = "DAIRO-HY/DairoNPS"
        BRANCH = "release"
    }
    stages {
        stage("拉取代码") {
            steps {
                script{
                    if(!fileExists("DairoNPS")){
                        def cloneUrl = "https://${env.GITHUB_TOKEN}@github.com/${env.REPO}.git"
                        echo "克隆地址:${cloneUrl}"
                        sh "git clone --branch ${env.BRANCH} ${cloneUrl}"
                    }
                }
                dir("DairoNPS"){

                    //撤销所有修改
                    sh "git reset --hard HEAD"

                    //删除所有未被跟踪的文件和目录
                    sh "git clean -fd"
                    sh "git pull"
                }
            }
        }
        stage("构建镜像") {
            steps {
                dir("DairoNPS/document/docker-build"){

                    //--no-cache：忽略缓存，解决一些莫名其妙的问题
                    //--network=host：强制使用主机网络。当在容器中构建镜像时（如：jenkins容器中构建镜像），否则可能会导致网络连接失败而无法通过Dockerfile构建镜像
                    sh "docker build --no-cache --network=host -t dairo-nps-build ."
                    sh "yes|docker image prune"
                }
            }
        }
        stage("编译") {
            steps {
                sh "docker run -e GITHUB_TOKEN=$GITHUB_TOKEN -e DOCKER_USER=$DOCKER_USER -e DOCKER_PWD=$DOCKER_PASSWORD -v /var/run/docker.sock:/var/run/docker.sock --rm dairo-nps-build"
            }
        }
    }
}
